# План реализации (актуализация: 2026-02-26)

## 1) Назначение документа
- Этот файл хранит только **план предстоящих работ** и приоритеты.
- После закрытия блока задач, сделанный функционал фиксируется в документах и убирается отсюда.

## 2) Где фиксируется закрытое
- Технические результаты и срезы качества: `docs/audits/*`.
- Актуальная архитектура и инварианты: `docs/architecture-overview.md`.
- Актуальное продуктовое поведение: `docs/product-spec.md`.
- История изменений по коммитам/PR: git history.

## 3) Активные приоритеты

### Временный статус блока (до закрытия)

Правило ведения:
- В roadmap держим только **временные пункты по текущему блоку**, пока он не закрыт.
- После закрытия блока результат переносится в:
   - продуктовое поведение: `docs/product-spec.md`,
   - архитектурные изменения и инварианты: `docs/architecture-overview.md`,
   - аудит/качество (при необходимости): `docs/audits/*`.
- Из roadmap закрытый блок удаляется, чтобы не дублировать «источник правды».

Временный прогресс текущего блока:
- [x] Декомпозиция `App` на компоненты (`AppHeader`, `ProjectHomeSection`, `CompanyTabsContent`, `AdminUsersTable`).
- [x] Ужесточение доступа к admin console (только superadmin).
- [x] GitOps-поставка в `test` с feature-ветки и подтвержденные smoke health-check.
- [x] Усилен pipeline верификации: добавлен `typecheck` для web.
- [~] P1 started: унификация формулы KPI «Мои планы» под годовую утилизацию.
- [~] P2 in progress: в селекторе компаний добавлены счетчики планов `Название (N)` + реактивное обновление после операций с планами (test).

#### Next (ближайший фокус)

##### P1 — Критичный баг расчета нагрузки
1. [ ] Исправить расхождение процентов в «Мои планы» vs «Годовая нагрузка».
   - [x] Использовать единую формулу агрегации в обоих виджетах.
   - [~] Убрать аномалии вида `>1000%` при реальном значении около `94%`.
   - [x] Добавить regression-check для невалидного раздувания KPI (smoke guard на `/auth/projects`).
    - **DoD:**
       - [ ] На тестовых данных значения в обоих блоках совпадают (допуск: не более 0.1 п.п.).
       - [ ] Невозможно получить аномальный процент при валидных входных данных.
       - [ ] `npm run check` и `SMOKE_API=1 npm run check` проходят.

##### P2 — Прозрачность списка компаний
1. [~] В селекторе компаний показывать количество планов в формате `Название компании (N)`.
   - [x] `N` соответствует числу планов в текущем контексте пользователя.
   - [x] Значение обновляется реактивно при смене компании/планов.
    - **DoD:**
      - [ ] Счетчик корректен для owner и non-owner сценариев.
      - [x] После create/copy/delete/switch plans счетчик обновляется без перезагрузки страницы.
      - [ ] Ручной smoke сценария переключения компаний пройден.

#### Later (после стабилизации P1/P2)
- [ ] Импорт XLSX новой компании (`docs/imports/xlsx-company-import-plan.md`).
- [ ] Анимации сворачивания/разворачивания ключевых UI-блоков.
- [ ] AI-помощник для интеллектуальной правки планов (discovery -> MVP).
- [ ] Монетизация и killer-features (discovery).

### P3 — Качество и проверка поставки
1. [x] Закрепить минимальный набор post-deploy проверок для `test`:
   - [x] `npm run check`,
   - [x] `SMOKE_API=1 npm run check` (в e2e smoke добавлен preflight API availability + skip-safe поведение; подтверждено на `test` с `E2E_API_URL=https://test.projo.gismalink.art/api` после деплоя `c6e5a50`),
   - [x] ручной smoke критического user-flow (подтверждено: login/logout в SSO режиме работает; авто-probe redirect/logout также пройден).
2. [x] Добавить release checklist перед `prod`:
   - [x] backup БД (процедура и команда зафиксированы в `docs/release-runbook.md`, раздел `Шаг C.1`),
   - [x] green test-smoke,
   - [x] подтвержденный changelog (`docs/releases/RELEASE_NOTES_2026-02-26_RC1.md`),
   - [x] мониторинг после выката (процедура и команды зафиксированы в `docs/release-runbook.md`, раздел `Шаг D.1`).
3. [x] Добавить базовую наблюдаемость:
   - [x] access/error logs,
   - [x] uptime/5xx/latency метрики,
   - [x] алерты на деградацию health-check.
4. [x] Провести нагрузочное тестирование (конкурентное редактирование планов):
   - выполнено и зафиксировано: `docs/performance/load-testing-plan.md` (раздел `9.1`, прогоны `test` и практический baseline по VU/p95/error-rate).

### P3.5 — Post-cutover hardening (tech audit 2026-02-24)
Источник: `docs/audits/technical-audit-2026-02-24.md`.

1. [x] CORS deny-path: вместо error -> `callback(null, false)` + безопасное логирование origin.
2. [x] SSO proxy: добавить timeout на upstream fetch + контролируемую ошибку.
3. [x] Web config safety: заменить fallback `VITE_API_URL` на `/api` (чтобы misconfig не вшивал `localhost:4000/api` в bundle).
4. [x] Reduce config drift: `VITE_*` build args в `infra/docker-compose.host.yml` перевести на env-substitution (единый источник значений).
5. [x] Deploy scripts: явный маркер deployed SHA (файл/лог) + предупреждение про detached HEAD.

### P4.5 — Импорт XLSX (новая компания)
План: `docs/imports/xlsx-company-import-plan.md`.

### P4 — Функциональные улучшения после стабилизации
1. [ ] Довести стабильность UX/метрик timeline на краевых сценариях.
   - [ ] Во время драга со скамейки сворачивать проекты, чтобы не тащить карточку через весь экран и не скроллить вручную.
2. [~] Усилить тестовое покрытие критических сценариев (assignment/member, shift/resize, auth-flow).
   - [x] Добавлен e2e smoke сценарий `project copy preserves members and assignments` (`scripts/e2e-api-smoke.test.mjs`).
   - [x] Добавлен e2e smoke сценарий `assignment update restores membership after member removal` (проверка инварианта member/assignment lifecycle).
   - [x] Добавлен e2e smoke сценарий `assignment outside project range is allowed and visible in timeline` (регресс на policy fact-range без блокировки CRUD).
   - [x] Выполнен SSO token-run (`E2E_ACCESS_TOKEN`) для non-skip smoke: `pass=3`, `fail=0`, `skip=9`; employee-зависимые сценарии skip-safe при пустом `roles` в текущем workspace scope.
3. [ ] Добавить страницу статистики для владельца/админа:
   - [ ] общее количество пользователей,
   - [ ] общее количество проектов,
   - [ ] количество проектов по каждому пользователю.
   - [ ] таблица пользователей с колонками: user, role, projects count, plans count.
4. [ ] Исследовать и реализовать мультикурсор в рамках проекта (desktop-only):
   - [ ] пользователи в одном проекте видят курсоры друг друга в реальном времени,
   - [ ] поддержать роли viewer/editor/owner,
   - [ ] не включать функциональность на мобильных устройствах.
5. [ ] Проверить адаптивность ключевых экранов и исправить стили для мобильных устройств.
6. [ ] Добавить предварительную валидацию полей на фронте (до отправки формы на API).
7. [ ] Подготовить следующий пакет продуктовых улучшений (отчеты, фильтры, интеграционные API-контракты).
8. [ ] Добавить анимации сворачивания/разворачивания ключевых UI-блоков:
   - [ ] фильтры,
   - [ ] секции списков,
   - [ ] панели с деталями/контекстом.
   - [ ] единый motion-pattern и тайминги, без перегруза интерфейса.
9. [ ] Проработать AI-помощник для интеллектуальной правки планов (discovery -> MVP):
   - [ ] определить use-cases (поиск конфликтов, балансировка загрузки, рекомендации),
   - [ ] спроектировать безопасный API-контур (read/write scope, audit trail),
   - [ ] сделать MVP (чат + ограниченный набор команд изменения плана),
   - [ ] ввести режим «предложение -> подтверждение пользователем».

### P5 — Продукт и монетизация (discovery)
1. [ ] Сформировать гипотезы монетизации:
   - [ ] free/team/pro тарифы,
   - [ ] лимиты по пользователям/проектам,
   - [ ] paid add-ons (расширенная аналитика, AI-помощник, интеграции).
2. [ ] Выделить killer-features продукта:
   - [ ] 3–5 дифференциаторов по сравнению с альтернативами,
   - [ ] оценка ценности для owner/manager/employee,
   - [ ] привязка к roadmap и влиянию на конверсию/удержание.

## 5) Связанные документы
- `docs/audits/security-audit-2026-02-18.md`
- `docs/architecture-overview.md`
- `docs/product-spec.md`
- `docs/workflow-checklist.md`
- `docs/release-runbook.md`
- `docs/server-deploy-mac.md`
