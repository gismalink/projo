# План реализации

## Статус чеклиста (обновлено 2026-02-15)

### Этап 1: Фундамент
- [x] backend/frontend scaffold
- [x] auth + RBAC (Admin/PM/Viewer/Finance)
- [x] Prisma schema + миграции + локальный PostgreSQL

### Этап 2: Справочники
- [x] Roles API + UI
- [x] Employees API + UI
- [x] Employees UX: popup для создания сотрудника и popup отпусков из строки сотрудника
- [x] Фильтры по ролям на списке сотрудников
- [x] Карточки сотрудников по отделам (UI группировка)
- [x] Отображение грейдов сотрудников
- [x] Skills API + UI
- [x] CSV импорт сотрудников
- [x] Отпуска (Vacation) CRUD
- [x] Ставки (CostRate) CRUD

### Этап 3: Проекты и таймлайн
- [x] Projects CRUD
- [x] Assignments CRUD
- [x] Годовой timeline API
- [x] Timeline UI
- [x] Project Card UI (просмотр и редактирование назначений)
- [x] Плановая стоимость (Cost engine)

### Этап 4: Валидации/конфликты/отчеты
- [x] Конфликт перегруза сотрудника >100% (soft warning, без hard-block на create/update)
- [x] Конфликт assignment vs vacation (soft warning, без hard-block; отпуск подсвечивается красным в строке сотрудника)
- [x] Индикатор годовой загрузки сотрудника (UI, по assignments)

## Backlog (после текущего спринта)
- [x] Формальный справочник `Department` в БД (связь с сотрудниками вместо UI-эвристик по ролям)
- [x] Полная i18n-локализация всех backend- и frontend-сообщений
- [x] Редактирование плановых дат проекта (`startDate`/`endDate`) из UI таймлайна/карточки проекта
- [x] Форматирование `costSummary.totalPlannedCost` через `Intl.NumberFormat` (RU/EN)
- [x] Поле `Role.shortName` + backfill и использование в Team-фильтрах и Timeline bench

## Новый triage по экрану Команда (бывш. Сотрудники)

### Wave T1 (быстрые UX-правки фильтров и отпусков)
- [x] Даты отпусков показывать с месяцами словами (локализованный формат), а не числовым месяцем.
- [x] Кнопку выбора отдела в фильтрах заменить на иконку с выпадающим списком.
- [x] Кнопку «Сбросить фильтры» заменить на иконку.
- [x] Сократить тексты чипов/кнопок фильтров; полные названия показывать в tooltip.
- [x] Фильтры отделов вынести в отдельную строку от остальных фильтров.

### Wave T2 (структура раздела и справочник отделов)
- [x] Переименовать раздел «Сотрудники» в «Команда» (UI + i18n + навигация).
- [x] Добавить кнопку «Список отделов».
- [x] Реализовать popup управления отделами (просмотр/редактирование списка отделов).

## Новый triage по экрану Роли

### Wave R1 (упрощение флоу управления ролями)
- [x] Создание роли унести из inline-формы в кнопку + popup.
- [x] Добавить возможность редактировать роль (минимум: `name`, `shortName`, `description`, `level`, `colorHex`).
- [x] Убрать явное сохранение по кнопке в списке ролей: сохранять изменения на лету (optimistic/autosave с защитой от частых запросов).
- [x] Удалить из UI блок навыков как избыточный для текущего scope проекта.

## Новый triage по экрану Timeline (обновлено 2026-02-15)

### Wave 1 (делаем сейчас, быстрый UX-выигрыш)
- [x] `Создать проект` унести в popup + кнопка вызова.
- [x] `Назначить сотрудника` унести в popup; кнопку показывать только в карточке проекта.
- [x] Карточка проекта разворачивается под строкой проекта.
- [x] Разрешить одновременно раскрывать несколько проектов.
- [x] Таймлайн растянуть на доступную ширину контейнера.
- [x] На всех таймлайнах показать линию текущей даты.

### Wave 2 (после Wave 1, средняя сложность)
- [x] Перейти с месячной сетки на день/месяц (day-level grid + month headers).
- [x] В раскрытом проекте показывать employee-level bars как в Gantt.
- [x] Добавить верхний агрегированный timeline компании (дневная загрузка, столбчатая диаграмма).

### Wave 2.5 (интерактив планирования, сделано 2026-02-14)
- [x] Серый `planned`-бар проекта без скруглений + employee strips внутри по датам.
- [x] Цвет employee strips по цвету роли; толщина полосы зависит от allocation (1px..10px).
- [x] Drag-and-drop `planned`-бара: центр двигает проект целиком, левый/правый край меняют start/end.
- [x] При move и resize-start вложенные assignment даты сдвигаются вместе; при resize-end не сдвигаются.
- [x] Разрешены assignment даты вне project range (для планирования итеративными сдвигами).
- [x] Разворачивание project card только отдельной кнопкой-стрелкой под строкой (клик по строке отключен).
- [x] Drag `planned`-бара не раскрывает карточку проекта автоматически.
- [x] Drag `planned`-бара продолжается при выходе курсора за пределы строки таймлайна.
- [x] Ручная сортировка строк проекта (`↑/↓`) в заголовке строки; авто-сортировка по датам отключена.
- [x] Tooltip на `planned`-баре: hover/drag, край показывает крайнюю дату, центр — диапазон дат.
- [x] Drag в упоре к границам года без рассинхрона вложенных полос и без визуального отката после mouseup.
- [x] Move-drag жёстко ограничен границами года (после упора в край обе границы бара остаются стабильны).
- [x] Визуальная тема `apps/web` обновлена в сторону iOS-style (surface/controls/timeline/modal/toast).

### Wave 3 / Backlog (требует доп. модели данных и DnD)
- [x] Правая колонка `bench`: отделы + карточки сотрудников, drag-and-drop в проект.
- [x] Удаление участника из проекта кнопкой в раскрытой строке.

### Wave 3.5 (UX-polish по timeline)
- [x] Скамейку вынести еще правее, визуально за пределы списка проектов.
- [x] В bench-карточке показывать глобальный процент загрузки сотрудника за выбранный год.
- [x] Имена на bench сокращать до инициалов (полное имя в tooltip).
- [x] Сделать на bench больше колонок/плотнее раскладку, чтобы помещалось больше сотрудников.
- [x] В employee timeline убрать контурную рамку строки сотрудника.
- [x] В employee timeline уменьшить вертикальные отступы в строке сотрудника.
- [x] Долокализовать текст/подписи/aria-label в строке проекта, где еще остались hardcoded-строки.
- [x] Финально подогнать визуал границ сетки и drag-хэндлеров в timeline (1d/1w/1m), чтобы границы и hit-area совпадали пиксель-в-пиксель с логикой расчета дат.
- [x] Drag левого края проекта с зажатым `Cmd/Ctrl`: изменять только край без сдвига вложенного содержимого.
- [x] Drag периода (центр) с зажатым `Cmd/Ctrl`: перемещать только период проекта без сдвига вложенного содержимого.

### Открытые решения перед Wave 3
- [x] Ввести сущность `ProjectMember` (M2M Project-Employee) отдельно от `ProjectAssignment`.
- [x] Определить правило синхронизации: удаление последнего assignment не удаляет member автоматически.
- [x] Ограничения прав на DnD-операции (ADMIN/PM).

## 1. Стратегия поставки
Делаем вертикальными срезами: сначала рабочий сценарий планирования, затем контроль качества данных и отчетность.

## 2. Фрейм этапов (без дублирования)

### Этап 0: Discovery и выравнивание (~1 неделя)
- Согласовать словарь домена и бизнес-правила.
- Зафиксировать границы MVP и критерии успеха.
- Подготовить и утвердить вайрфреймы ключевых экранов.

### Этапы 1–5
- Статусы, scope и факт выполнения ведутся в разделе «Статус чеклиста» в начале документа.
- Текущие продуктовые инициативы и UX-изменения ведутся в triage-секциях (`Команда`, `Timeline`) и в `Backlog`.

## 3. Структура backlog (рекомендуемые эпики)
1. Identity and Access
2. Employee Master Data
3. Role and Skill Management
4. Project Lifecycle
5. Assignment Planning
6. Timeline/Gantt UX
7. Cost Engine
8. Conflict Detection
9. Reports and Export
10. Audit and Observability

## 4. Решения по данным и расчетам, которые нужно зафиксировать заранее
1. Единица планирования: проценты vs часы/день (или обе, но с одной канонической единицей).
2. Гранулярность времени: день как source of truth, неделя как агрегированное представление.
3. Приоритет ставок: персональная ставка сотрудника выше ставки роли по умолчанию.
4. Производственные календари: общий календарь или региональный на сотрудника.
5. Валюта в MVP: рекомендуется одна валюта.

### Решение по уровням планирования (принято)
- [x] Принят day-level как единый source-of-truth для хранения, расчётов и конфликтов.
- [x] Принята UX-квантовка drag/resize через глобальный переключатель шага на всём Timeline: `1d / 1w / 1m`.
- [x] Дефолтный шаг планирования: `1w`.
- [x] Значение шага — пользовательская настройка (persist на клиенте), единая для всех строк/проектов в текущем таймлайне.
- [x] Week/month режимы реализуются как шаг редактирования поверх day-level модели без отдельной week/month модели данных.

### Интеграция производственного календаря (план)
- [x] Подключить источник производственного календаря через API: https://calendar.kuzyak.in/swagger.
- [x] Реализовать backend-адаптер календаря (frontend не ходит во внешний API напрямую).
- [x] Ввести хранение календарных дней (`CalendarDay`) с полями: `date`, `isWeekend`, `isHoliday`, `isWorkingDay`, `holidayName?`.
- [x] Добавить кэширование календаря: prefetch текущего/следующего года, TTL 24ч, fallback на последний успешный снимок.
- [x] Добавить расписание обновления календаря: ежедневный sync + ручной admin refresh + auto-refresh при смене года.
- [x] Добавить UI-подсветку выходных/праздников на timeline и в графиках загрузки.
- [x] Добавить в tooltip дня тип дня (рабочий/выходной/праздник) и название праздника.
- [x] Пересчитать фактическое время assignment с учетом выходных, праздников и отпусков (day-level расчет).
- [x] Добавить конфиг `standardDayHours` (дефолт 8ч) как базу для расчета фактических часов.
- [x] Вывести `факт, ч` рядом с нагрузкой в строке assignment на timeline.
- [x] Добавить агрегат фактических часов в проектных итогах (`project details` / summary).
- [x] Добавить метрику «потерянные часы» (`planned - actual`) в строке assignment и/или агрегате проекта.
- [x] Добавить легенду цветов типов дня (рабочий/выходной/праздник/отпуск).
- [x] Добавить переключатель сценария «учитывать/не учитывать производственный календарь» для сравнения план/факт.
- [x] Добавить health-метрику календаря: дата/время последнего успешного sync и статус актуальности.

Открытые решения:
- [x] Что считать «видимым диапазоном» для `факт, ч`: принят `assignment`-диапазон как базовый MVP-сценарий.
- [x] Нужны ли разные календари по стране/локации/офису: в MVP принят единый календарь (РФ), мультикалендари отложены.
- [x] Что делать при частичном рабочем дне (если API это поддерживает): в MVP день считается бинарно (рабочий/нерабочий), partial-day отложен.

## 5. Стратегия тестирования
1. Unit-тесты:
- расчет стоимости,
- валидация загрузки,
- правила конфликтов.

2. Integration-тесты:
- агрегация данных проекта/назначений/таймлайна,
- RBAC-права по endpoint'ам.

3. End-to-end тесты:
- создание/редактирование проекта и назначений,
- детектирование конфликтов и отображение предупреждений в UI,
- экспорт отчетов.

## 6. Риски и снижение рисков
1. Риск производительности на годовом таймлайне:
- снизить через агрегированные read-модели и виртуализацию/пагинацию.

2. Неоднозначные данные при миграции из таблиц:
- снизить через жесткий шаблон импорта и отчет валидации.

3. Разрастание scope до запуска MVP:
- снизить через жесткую границу MVP и контроль изменений в backlog.

## 7. Ближайшие практические шаги
1. Завершить UX-polish timeline: точное выравнивание сетки/хэндлеров и итоговая локализация подписей.
2. Реализовать `ProjectMember` (модель + API + DnD-flow) и закрыть открытые решения по синхронизации с assignment.
3. Запустить Phase 1 интеграции производственного календаря (backend-адаптер, хранение, кэш, sync).
4. Добавить на timeline отображение `actualHours` рядом с нагрузкой assignment и проектными агрегатами.
5. Подготовить тестовый контур для новых расчетов (unit + integration на календарь/отпуска/переносы).

## 8. Самый последний этап: Стабилизация
- [x] Интеграционные и e2e тесты
- [x] Аудит изменений
- [x] Профилирование производительности
