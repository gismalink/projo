# План реализации (актуализация: 2026-02-16)

## 1. Текущая базовая точка
- Реализованный функциональный scope зафиксирован в `docs/product-spec.md`.
- Техническая декомпозиция и границы модулей зафиксированы в `docs/architecture-overview.md`.
- Этот документ хранит только план следующих поставок и приоритеты.

## 2. Приоритеты следующего этапа

### Что закрыто в последнем инкременте
- Реализован backend модуль `team-templates` (CRUD + RBAC).
- Добавлен UI-редактор шаблонов в Settings.
- Добавлена привязка шаблона к проекту (create/edit).
- Проверка missing roles в Timeline переведена на выбранный шаблон проекта.
- Добавлен чип выбранного шаблона в строке проекта.
- Продолжен безопасный рефакторинг Timeline: date/marker утилиты вынесены в `apps/web/src/components/timeline/timeline-date.utils.ts`.
- Продолжена декомпозиция web-hooks: salary parsing/conversion вынесены в `apps/web/src/hooks/salary.utils.ts`.

### P1 — техдолг и срочный рефакторинг
1. [x] Убрать хардкод bootstrap-учеток из web state и API service:
   - перенести в env/config,
   - оставить безопасные dev defaults только через `.env`.
2. [x] Устранить `as any` в `apps/api/src/team-templates/team-templates.service.ts`:
   - восстановить строгую типизацию Prisma delegate после полной регенерации/проверки типов.
3. [x] Централизовать магические числа и дефолты UI/API:
   - `MONTHLY_HOURS = 168`, `setTimeout(..., 4500/420)`, дефолтные цвета и статусы.
   - вынесены shared constants для web (`app.constants.ts`, `seed-defaults.constants.ts`) и ключевые API constants (`app-constants.ts`);
   - `TimelineTab`, `useAppHandlers`, `useAppState`, `RolesTab`, `ProjectTimelineItem`, `EmployeeModal`, `PersonnelTab`, `BenchColumn`, `app-helpers`, `calendar.service`, `roles.service` переведены на именованные константы.
4. [x] Убрать локализацию через косвенные хардкоды вида `t.prev === 'Назад'` в пользу явного `lang`/locale state.

### P2 — стабильность и покрытие
1. [~] Добавить целевые integration/e2e сценарии по критическим потокам:
   - login,
   - register + account management (`/auth/me`, `change-password`),
   - timeline drag/update,
   - department/role color persistence,
   - project member + assignment consistency.
   - сделано частично: расширен `scripts/e2e-api-smoke.test.mjs` сценарием `auth + project member + assignment consistency`,
     плюс проверки валидаций `duplicate assignment -> 409` и `invalid date range -> 400`.
   - добавлен smoke-сценарий `project shift/resize -> assignment consistency` (через последовательные `PATCH /projects/:id` + `PATCH /assignments/:id` и проверку `GET /projects/:id`).
   - добавлен smoke-сценарий `account register + me + password change`.
2. [~] Укрепить smoke-check для CI (минимальный сценарий создания проекта и назначения).
   - добавлен runtime-smoke поток с созданием проекта, добавлением member, созданием assignment и проверкой консистентности в `GET /projects/:id`.
   - добавлены негативные проверки по error-кодам для конфликтов/валидации дат в assignments.
   - добавлен runtime-smoke поток для project shift/resize с валидацией целостности assignment-дат после обновлений.

### P3 — консолидация модели планирования
1. Зафиксировать и документировать жизненный цикл `ProjectMember` vs `ProjectAssignment`.
2. Привести все UI-flow к единому правилу работы с member-пулом.
3. Добавить недостающие backend валидации и согласованные коды ошибок.

#### Детальный чек-лист (этап 2)

##### 1) Правила предметной модели
- [ ] Зафиксировать единое правило: когда создается `ProjectMember`, когда создается `ProjectAssignment`, когда сущности синхронизируются.
- [ ] Зафиксировать допустимые состояния сотрудника в проекте: «только member», «member + assignment», «удален из проекта».
- [ ] Зафиксировать поведение при удалении assignment: остается ли member в пуле, при каких условиях удаляется.
- [ ] Зафиксировать поведение при смещении дат проекта: что происходит с assignment и какими ограничениями это защищено.
- [ ] Обновить описание инвариантов в `docs/architecture-overview.md` и `docs/product-spec.md`.

##### 2) Backend API и валидации
- [ ] Проверить и выровнять контракты для потоков:
   - [ ] add/remove project member,
   - [ ] create/update/delete assignment,
   - [ ] чтение project details для timeline.
- [ ] Добавить/уточнить валидации:
   - [ ] запрет assignment вне диапазона проекта,
   - [ ] запрет assignment для сотрудника вне member-пула (или авто-добавление по зафиксированному правилу),
   - [ ] запрет конфликтных дублей,
   - [ ] корректная обработка пересечений и граничных дат.
- [ ] Выровнять коды ошибок в `apps/api/src/common/error-codes.ts` под все ветки валидации.
- [ ] Проверить DTO/сервисы на согласованность полей и nullability.
- [ ] Проверить, что `ProjectDetail` всегда возвращает полный набор полей, нужных UI (включая role/grade/status, если используются в timeline).

##### 3) База данных и миграции
- [ ] Проверить, что Prisma schema отражает целевые ограничения:
   - [ ] уникальность и индексы по `ProjectMember`/`ProjectAssignment`,
   - [ ] корректные `onDelete` стратегии,
   - [ ] отсутствие «осиротевших» ссылок.
- [ ] Если schema меняется — создать migration и прогнать `prisma:generate` + `prisma:migrate`.
- [ ] Подготовить скрипт/план data-fix для legacy-данных (если найдены несогласованные member/assignment записи).

##### 4) Frontend flow и UX-сценарии
- [ ] Привести все входы создания assignment к одному сценарию (из карточки проекта, из bench drag&drop и т.д.).
- [ ] Явно отобразить в UI источник проблемного состояния (понятный текст ошибки для пользователя).
- [ ] Проверить, что после операций add/remove/update данные синхронно отражаются в:
   - [ ] timeline row,
   - [ ] assignment list,
   - [ ] bench/load виджетах.
- [ ] Проверить, что автообновление/refresh не ломает текущий контекст пользователя (раскрытый проект, выбранная строка, редактирование).

##### 5) Тесты и проверка качества
- [ ] Добавить integration/e2e сценарии для этапа 2:
   - [ ] member added → assignment created,
   - [ ] assignment removed → member state validated,
   - [ ] invalid assignment date → expected error code,
   - [ ] project shift/resize → assignment consistency check.
- [ ] Обновить smoke-check так, чтобы покрывался минимум один полный поток этапа 2.
- [ ] Прогнать `npm run verify` и при изменениях runtime API — `SMOKE_API=1 npm run verify`.

##### 6) Документация и критерии завершения
- [ ] Обновить `docs/api-reference.md` (входные/выходные поля, ошибки, примеры).
- [ ] Обновить `docs/product-spec.md` (ожидаемое пользовательское поведение).
- [ ] Обновить `README.md` только если изменились запуск/проверки/операционные шаги.
- [ ] Зафиксировать в PR/релиз-заметке итоговые инварианты модели.

##### Definition of Done (этап 2)
- [ ] Нет расхождений между member-пулом и assignment в целевых сценариях.
- [ ] Все критические ветки валидации покрыты тестами.
- [ ] API, UI и docs синхронизированы по контрактам и терминологии.
- [ ] Verify/Smoke проходят стабильно на чистом окружении.

### P4 — календарь и расчетные метрики
1. Довести в UI календарные эффекты план/факт до стабильного пользовательского сценария.
2. Проверить и выровнять расчет `actual/lost` часов на краевых датах и отпусках.
3. Добавить диагностические метрики синка календаря в операционные проверки.

### P5 — продуктовые улучшения после стабилизации
1. Отчеты/экспорт (CSV/Excel) по загрузке и стоимости.
2. Улучшение фильтрации/поиска на Team и Timeline.
3. Подготовка API-контрактов для будущих интеграций.

## 2.1 Ближайшие работы (дополнение)

## 2.2 UX входа/аккаунта и открытые вопросы (2026-02-17)

### Что принято в ближайшем инкременте (UX-only)
- [ ] Перевести карточку профиля пользователя в pop-up по паттерну login/register.
- [ ] Усилить обратную связь формы входа/регистрации:
   - [ ] явные toast-ошибки при неуспешной авторизации,
   - [ ] одинаковое поведение для backend ошибок и локальных валидаций.
- [ ] Перенести глобальный toast-stack из левого нижнего угла в нижний центр.
- [ ] В хедере показывать, кто авторизован (ФИО вместо абстрактного «Аккаунт»).
- [ ] Переместить контрол пользователя левее переключателя языка.

### Открытые вопросы по организациям/workspace
- [ ] Как выбирать организацию/workspace в UI.
- [ ] В этом инкременте зафиксирован режим **без переключения workspace** (UX-only).
- [ ] Переключение workspace вынести в отдельный этап после полноценного backend-контракта:
   - пользователь может видеть все расшаренные ему воркспейсы и переключаться между ними
   - [ ] список membership,
   - [ ] смена active workspace,
   - [ ] полное tenant-scoping покрытие модулей timeline/assignments/vacations/cost-rates.

- [ ] Проверить и исправить логику скамейки, чтобы в ней всегда отображались все сотрудники (включая кейсы с частичной/нулевой загрузкой, фильтрами и сменой года).
- [ ] Перенести «таймлайн года» в ту же колонку, где отображаются проекты, чтобы при увеличении высоты скамейки все таймлайны оставались одной ширины.
- [x] Добавить фильтр по сотруднику на скамейке:
   - [x] при выборе сотрудника остаются только проекты/таймлайны, где он участвует;
   - [x] в этих таймлайнах визуально выделяется только выбранный сотрудник.
- [ ] Проверить общий таймлайн в режиме шага «день»: в выходные дни не должна отображаться нагрузка;
   - [ ] найти источник ошибки (визуализация столбцов или расчет метрик);
   - [ ] исправить расчет/рендер и подтвердить корректность на ручном smoke-сценарии.
- [ ] Добавить для проектов шаблон требований к составу команды (например: обязательный PM, Lead и другие роли по конфигурации):
   - [ ] определить формат шаблона и где он хранится (настройки/справочник/уровень проекта);
   - [ ] реализовать проверку соответствия фактического состава сотрудников шаблону;
   - [ ] добавить API и UI для выбора/привязки шаблона к проекту.
- [ ] Добавить в таймлайн отдельный блок «Ошибки» с красными иконками и tooltip-пояснениями:
   - [ ] показывать нехватку сотрудников по проектному шаблону (кто именно отсутствует);
   - [ ] показывать наличие отпусков у сотрудников проекта в плановом периоде;
   - [ ] показывать выход факта за пределы плана (по часам/нагрузке);
   - [ ] унифицировать приоритет и сортировку ошибок, чтобы критичные всегда были выше.

## 2.3 Проектно-ориентированная модель доступа (kickoff: 2026-02-17)

### Подтвержденная идеология
- [ ] Пользователь может иметь несколько «проектов-контейнеров» (бывших workspace).
- [x] Стартовый экран после входа: «Мои проекты» + «Проекты, куда меня добавили» + кнопка создания нового проекта.
- [x] В рабочем экране над таймлайном отображается название текущего проекта и кнопка возврата на стартовый экран.
- [ ] Права внутри проекта:
   - [x] `owner`: полный доступ ко всем вкладкам и настройкам проекта,
   - [x] `editor`: полный доступ в таймлайне, просмотр участников без управления правами,
   - [x] `viewer`: только просмотр таймлайна.

### Текущий статус (первый инкремент)
- [x] Backend: добавлены endpoints для списка доступных проектов пользователя, создания проекта-контейнера и переключения active проекта (через `auth` API).
- [x] Frontend: реализован базовый стартовый экран выбора проекта и переключение контекста через новые `auth/projects` endpoints.
- [x] Frontend: список проектов на стартовом экране переведен на карточки с переходом по клику.
- [x] Frontend: единый project pop-up (участники + редактирование названия owner-only) вызывается и со стартового экрана, и из шапки рабочего экрана.
- [x] Frontend/Backend: owner-only управление участниками в project pop-up (смена роли viewer/editor, удаление участника).
- [x] QA/UX: добавлен confirm на удаление участника и API smoke-сценарий update/remove роли участника.
- [x] UX: добавлен быстрый поиск участников в project pop-up (по ФИО/email).
- [x] Backend: добавить приглашение по email существующего пользователя с назначением `viewer/editor`.
- [x] Backend: довести полное scoping-покрытие модулей `timeline/assignments/vacations/cost-rates`.
   - [x] assignments: workspace-scoping внедрен (API + service).
   - [x] timeline: workspace-scoping внедрен (API + service).
   - [x] vacations: workspace-scoping внедрен (API + service + DB).
   - [x] cost-rates: workspace-scoping внедрен (API + service + DB).
- [x] Frontend: добавить owner-only pop-up настроек проекта (участники, роли доступа, приглашения).
- [x] Frontend: добавлен role-gating вкладок/модалок по модели owner/editor/viewer.
- [x] Backend: editor ограничен от мутаций вне timeline (employees/vacations/skills assignment).

## 3. Принципы поставки
- Двигаемся короткими вертикальными инкрементами (API + UI + docs + smoke).
- Любое изменение схемы БД сопровождается Prisma migration.
- Документация (`README` + `docs/*`) обновляется в том же инкременте.

## 4. Связанные документы
- API-контракты: `docs/api-reference.md`.
- Процедурный чеклист инкремента: `docs/workflow-checklist.md`.