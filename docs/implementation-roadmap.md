# План реализации

## Статус чеклиста (обновлено 2026-02-14)

### Этап 1: Фундамент
- [x] backend/frontend scaffold
- [x] auth + RBAC (Admin/PM/Viewer/Finance)
- [x] Prisma schema + миграции + локальный PostgreSQL

### Этап 2: Справочники
- [x] Roles API + UI
- [x] Employees API + UI
- [x] Employees UX: popup для создания сотрудника и popup отпусков из строки сотрудника
- [x] Фильтры по ролям на списке сотрудников
- [x] Карточки сотрудников по отделам (UI группировка)
- [x] Отображение грейдов сотрудников
- [x] Skills API + UI
- [ ] CSV импорт сотрудников
- [x] Отпуска (Vacation) CRUD
- [ ] Ставки (CostRate) CRUD

### Этап 3: Проекты и таймлайн
- [x] Projects CRUD
- [x] Assignments CRUD
- [x] Годовой timeline API
- [x] Timeline UI
- [x] Project Card UI (просмотр и редактирование назначений)
- [ ] Плановая стоимость (Cost engine)

### Этап 4: Валидации/конфликты/отчеты
- [x] Конфликт перегруза сотрудника >100%
- [x] Конфликт assignment vs vacation
- [x] Индикатор годовой загрузки сотрудника (UI, по assignments)
- [ ] Отчеты по загрузке и стоимости
- [ ] Экспорт CSV/Excel

### Этап 5: Стабилизация
- [ ] Интеграционные и e2e тесты
- [ ] Аудит изменений
- [ ] Профилирование производительности

## Backlog (после текущего спринта)
- [x] Формальный справочник `Department` в БД (связь с сотрудниками вместо UI-эвристик по ролям)
- [x] Полная i18n-локализация всех backend- и frontend-сообщений
- [ ] Редактирование плановых дат проекта (`startDate`/`endDate`) из UI таймлайна/карточки проекта

## Новый triage по экрану Timeline (2026-02-14)

### Wave 1 (делаем сейчас, быстрый UX-выигрыш)
- [x] `Создать проект` унести в popup + кнопка вызова.
- [x] `Назначить сотрудника` унести в popup; кнопку показывать только в карточке проекта.
- [x] Карточка проекта разворачивается под строкой проекта.
- [x] Разрешить одновременно раскрывать несколько проектов.
- [x] Таймлайн растянуть на доступную ширину контейнера.
- [x] На всех таймлайнах показать линию текущей даты.

### Wave 2 (после Wave 1, средняя сложность)
- [x] Перейти с месячной сетки на день/месяц (day-level grid + month headers).
- [x] В раскрытом проекте показывать employee-level bars как в Gantt.
- [ ] Добавить верхний агрегированный timeline компании (дневная загрузка, столбчатая диаграмма).

### Wave 3 / Backlog (требует доп. модели данных и DnD)
- [ ] Правая колонка `bench`: отделы + карточки сотрудников, drag-and-drop в проект.
- [ ] Разделить `участник проекта` и `assignment` (человек может быть в проекте с 0% загрузкой).
- [ ] Удаление участника из проекта кнопкой в раскрытой строке.
- [ ] DnD drop сотрудника в строку проекта автоматически добавляет `project member`.

### Открытые решения перед Wave 3
- [ ] Ввести сущность `ProjectMember` (M2M Project-Employee) отдельно от `ProjectAssignment`.
- [ ] Определить правило синхронизации: удаление последнего assignment удаляет member или нет.
- [ ] Ограничения прав на DnD-операции (ADMIN/PM).

## 1. Стратегия поставки
Делаем вертикальными срезами: сначала рабочий сценарий планирования, затем контроль качества данных и отчетность.

## 2. Этапы

### Этап 0: Discovery и выравнивание (~1 неделя)
Цели:
- согласовать словарь домена и бизнес-правила,
- зафиксировать границы MVP и критерии успеха,
- подготовить вайрфреймы ключевых экранов.

Результаты:
- утвержденный `product-spec.md`,
- набор вайрфреймов для Сотрудников, Ролей, Таймлайна, Карточки проекта,
- приоритизированный backlog с пометками MVP.

Критерий готовности:
- нет блокирующих вопросов по основным сущностям и ограничениям.

### Этап 1: Фундамент (~1 неделя)
Цели:
- инициализировать backend/frontend,
- поднять авторизацию и каркас RBAC,
- создать первую схему БД и миграции.

Результаты:
- локально запускаемый стек (frontend + backend + PostgreSQL),
- рабочий flow авторизации,
- RBAC middleware/guards для трех ролей,
- схема БД v1 для базовых сущностей.

Критерий готовности:
- защищенные endpoints работают в соответствии с ролями,
- миграции воспроизводимы в чистом окружении.

### Этап 2: Справочники (Сотрудники/Роли/Навыки) (~1-2 недели)
Цели:
- реализовать CRUD для справочников,
- добавить валидации и фильтры,
- добавить массовый импорт сотрудников.

Результаты:
- модуль сотрудников (API + UI),
- модуль ролей (API + UI),
- модуль навыков (API + UI),
- CSV-импорт и базовый интерфейс сопоставления полей.

Критерий готовности:
- пользователь может полностью управлять профилями сотрудников, ролями, навыками, отпусками и ставками.

### Этап 3: Проекты + таймлайн MVP (~2-3 недели)
Цели:
- реализовать CRUD проектов,
- реализовать годовой таймлайн,
- реализовать назначения и расчет стоимости.

Результаты:
- модуль проектов,
- UI таймлайна с поведением свернуть/развернуть,
- назначения с загрузкой по дням/неделям,
- сервис расчета плановой стоимости.

Критерий готовности:
- работает сквозной сценарий: создать проект -> назначить команду -> увидеть таймлайн и стоимость.

### Этап 4: Валидации, конфликты и отчеты (~1-2 недели)
Цели:
- включить контроль конфликтов в плане,
- добавить ключевые отчеты и экспорт.

Результаты:
- движок правил конфликтов (перегруз, пересечение с отпуском),
- UX предупреждений и override,
- отчеты по загрузке сотрудников и стоимости проектов,
- экспорт CSV/Excel.

Критерий готовности:
- конфликты надежно определяются и видны в таймлайне и карточке проекта.

### Этап 5: Стабилизация и пилот (~1 неделя)
Цели:
- повысить надежность и производительность,
- подготовить пилот на реальных данных.

Результаты:
- аудит критичных изменений,
- интеграционные и e2e тесты для ключевых сценариев,
- профилирование производительности и оптимизация запросов,
- чеклист пилота и заметки по запуску.

Критерий готовности:
- стабильная пилотная сборка, проверенная на репрезентативном наборе данных.

## 3. Структура backlog (рекомендуемые эпики)
1. Identity and Access
2. Employee Master Data
3. Role and Skill Management
4. Project Lifecycle
5. Assignment Planning
6. Timeline/Gantt UX
7. Cost Engine
8. Conflict Detection
9. Reports and Export
10. Audit and Observability

## 4. Решения по данным и расчетам, которые нужно зафиксировать заранее
1. Единица планирования: проценты vs часы/день (или обе, но с одной канонической единицей).
2. Гранулярность времени: день как source of truth, неделя как агрегированное представление.
3. Приоритет ставок: персональная ставка сотрудника выше ставки роли по умолчанию.
4. Производственные календари: общий календарь или региональный на сотрудника.
5. Валюта в MVP: рекомендуется одна валюта.

## 5. Стратегия тестирования
1. Unit-тесты:
- расчет стоимости,
- валидация загрузки,
- правила конфликтов.

2. Integration-тесты:
- агрегация данных проекта/назначений/таймлайна,
- RBAC-права по endpoint'ам.

3. End-to-end тесты:
- создание/редактирование проекта и назначений,
- детектирование конфликтов и отображение предупреждений в UI,
- экспорт отчетов.

## 6. Риски и снижение рисков
1. Риск производительности на годовом таймлайне:
- снизить через агрегированные read-модели и виртуализацию/пагинацию.

2. Неоднозначные данные при миграции из таблиц:
- снизить через жесткий шаблон импорта и отчет валидации.

3. Разрастание scope до запуска MVP:
- снизить через жесткую границу MVP и контроль изменений в backlog.

## 7. Ближайшие практические шаги
1. Заcкаффолдить backend (NestJS) и frontend (React + TypeScript).
2. Добавить начальную Prisma-схему и первую миграцию.
3. Реализовать базовый auth + RBAC.
4. В первую очередь отдать модули Сотрудников и Ролей как фундамент MVP.
