# План реализации (актуализация: 2026-02-16)

## 1. Текущая базовая точка
- Реализованный функциональный scope зафиксирован в `docs/product-spec.md`.
- Техническая декомпозиция и границы модулей зафиксированы в `docs/architecture-overview.md`.
- Этот документ хранит только план следующих поставок и приоритеты.

## 2. Приоритеты следующего этапа

### Что закрыто в последнем инкременте
- Реализован backend модуль `team-templates` (CRUD + RBAC).
- Добавлен UI-редактор шаблонов в Settings.
- Добавлена привязка шаблона к проекту (create/edit).
- Проверка missing roles в Timeline переведена на выбранный шаблон проекта.
- Добавлен чип выбранного шаблона в строке проекта.
- Продолжен безопасный рефакторинг Timeline: date/marker утилиты вынесены в `apps/web/src/components/timeline/timeline-date.utils.ts`.
- Продолжена декомпозиция web-hooks: salary parsing/conversion вынесены в `apps/web/src/hooks/salary.utils.ts`.

### P1 — техдолг и срочный рефакторинг
1. [x] Убрать хардкод bootstrap-учеток из web state и API service:
   - перенести в env/config,
   - оставить безопасные dev defaults только через `.env`.
2. [x] Устранить `as any` в `apps/api/src/team-templates/team-templates.service.ts`:
   - восстановить строгую типизацию Prisma delegate после полной регенерации/проверки типов.
3. [x] Централизовать магические числа и дефолты UI/API:
   - `MONTHLY_HOURS = 168`, `setTimeout(..., 4500/420)`, дефолтные цвета и статусы.
   - вынесены shared constants для web (`app.constants.ts`, `seed-defaults.constants.ts`) и ключевые API constants (`app-constants.ts`);
   - `TimelineTab`, `useAppHandlers`, `useAppState`, `RolesTab`, `ProjectTimelineItem`, `EmployeeModal`, `PersonnelTab`, `BenchColumn`, `app-helpers`, `calendar.service`, `roles.service` переведены на именованные константы.
4. [x] Убрать локализацию через косвенные хардкоды вида `t.prev === 'Назад'` в пользу явного `lang`/locale state.

### P2 — стабильность и покрытие
1. [~] Добавить целевые integration/e2e сценарии по критическим потокам:
   - login,
   - register + account management (`/auth/me`, `change-password`),
   - timeline drag/update,
   - department/role color persistence,
   - project member + assignment consistency.
   - сделано частично: расширен `scripts/e2e-api-smoke.test.mjs` сценарием `auth + project member + assignment consistency`,
     плюс проверки валидаций `duplicate assignment -> 409` и `invalid date range -> 400`.
   - добавлен smoke-сценарий `project shift/resize -> assignment consistency` (через последовательные `PATCH /projects/:id` + `PATCH /assignments/:id` и проверку `GET /projects/:id`).
   - добавлен smoke-сценарий `account register + me + password change`.
2. [~] Укрепить smoke-check для CI (минимальный сценарий создания проекта и назначения).
   - добавлен runtime-smoke поток с созданием проекта, добавлением member, созданием assignment и проверкой консистентности в `GET /projects/:id`.
   - добавлены негативные проверки по error-кодам для конфликтов/валидации дат в assignments.
   - добавлен runtime-smoke поток для project shift/resize с валидацией целостности assignment-дат после обновлений.

### P3 — консолидация модели планирования
1. Зафиксировать и документировать жизненный цикл `ProjectMember` vs `ProjectAssignment`.
2. Привести все UI-flow к единому правилу работы с member-пулом.
3. Добавить недостающие backend валидации и согласованные коды ошибок.

#### Детальный чек-лист (этап 2)

##### 1) Правила предметной модели
- [x] Зафиксировать единое правило: когда создается `ProjectMember`, когда создается `ProjectAssignment`, когда сущности синхронизируются.
- [x] Зафиксировать допустимые состояния сотрудника в проекте: «только member», «member + assignment», «удален из проекта».
- [x] Зафиксировать поведение при удалении assignment: остается ли member в пуле, при каких условиях удаляется.
- [x] Зафиксировать поведение при смещении дат проекта: что происходит с assignment и какими ограничениями это защищено.
- [x] Обновить описание инвариантов в `docs/architecture-overview.md` и `docs/product-spec.md`.

##### 2) Backend API и валидации
- [x] Проверить и выровнять контракты для потоков:
   - [x] add/remove project member,
   - [x] create/update/delete assignment,
   - [x] чтение project details для timeline.
- [ ] Добавить/уточнить валидации:
   - [x] запрет assignment вне диапазона проекта,
   - [x] запрет assignment для сотрудника вне member-пула (или авто-добавление по зафиксированному правилу),
   - [x] запрет конфликтных дублей,
   - [ ] корректная обработка пересечений и граничных дат.
- [ ] Выровнять коды ошибок в `apps/api/src/common/error-codes.ts` под все ветки валидации.
- [ ] Проверить DTO/сервисы на согласованность полей и nullability.
- [ ] Проверить, что `ProjectDetail` всегда возвращает полный набор полей, нужных UI (включая role/grade/status, если используются в timeline).

  Текущее состояние после audit:
   - assignment CRUD валидирует базовый диапазон дат (`start <= end`), уникальность пары `projectId + employeeId` и границы дат проекта;
  - assignment CRUD автоматически восстанавливает membership (`ProjectMember`) при create/update;
  - в `ProjectDetail` уже есть `role` и `grade`, поле `status` для assignment-employee в response сейчас не отдается.

##### 3) База данных и миграции
- [ ] Проверить, что Prisma schema отражает целевые ограничения:
   - [ ] уникальность и индексы по `ProjectMember`/`ProjectAssignment`,
   - [ ] корректные `onDelete` стратегии,
   - [ ] отсутствие «осиротевших» ссылок.
- [ ] Если schema меняется — создать migration и прогнать `prisma:generate` + `prisma:migrate`.
- [ ] Подготовить скрипт/план data-fix для legacy-данных (если найдены несогласованные member/assignment записи).

##### 4) Frontend flow и UX-сценарии
- [ ] Привести все входы создания assignment к одному сценарию (из карточки проекта, из bench drag&drop и т.д.).
- [ ] Явно отобразить в UI источник проблемного состояния (понятный текст ошибки для пользователя).
- [ ] Проверить, что после операций add/remove/update данные синхронно отражаются в:
   - [ ] timeline row,
   - [ ] assignment list,
   - [ ] bench/load виджетах.
- [ ] Проверить, что автообновление/refresh не ломает текущий контекст пользователя (раскрытый проект, выбранная строка, редактирование).

##### 5) Тесты и проверка качества
- [ ] Добавить integration/e2e сценарии для этапа 2:
   - [ ] member added → assignment created,
   - [ ] assignment removed → member state validated,
   - [ ] invalid assignment date → expected error code,
   - [ ] project shift/resize → assignment consistency check.
- [ ] Обновить smoke-check так, чтобы покрывался минимум один полный поток этапа 2.
- [ ] Прогнать `npm run verify` и при изменениях runtime API — `SMOKE_API=1 npm run verify`.

##### 6) Документация и критерии завершения
- [ ] Обновить `docs/api-reference.md` (входные/выходные поля, ошибки, примеры).
- [ ] Обновить `docs/product-spec.md` (ожидаемое пользовательское поведение).
- [ ] Обновить `README.md` только если изменились запуск/проверки/операционные шаги.
- [ ] Зафиксировать в PR/релиз-заметке итоговые инварианты модели.

##### Definition of Done (этап 2)
- [ ] Нет расхождений между member-пулом и assignment в целевых сценариях.
- [ ] Все критические ветки валидации покрыты тестами.
- [ ] API, UI и docs синхронизированы по контрактам и терминологии.
- [ ] Verify/Smoke проходят стабильно на чистом окружении.

### P4 — календарь и расчетные метрики
1. Довести в UI календарные эффекты план/факт до стабильного пользовательского сценария.
2. Проверить и выровнять расчет `actual/lost` часов на краевых датах и отпусках.
3. Добавить диагностические метрики синка календаря в операционные проверки.

### P5 — продуктовые улучшения после стабилизации
1. Отчеты/экспорт (CSV/Excel) по загрузке и стоимости.
2. Улучшение фильтрации/поиска на Team и Timeline.
3. Подготовка API-контрактов для будущих интеграций.

## 2.1 Ближайшие работы (дополнение)

### План: переменная загрузка внутри assignment (кривые, MVP)

1. Цель инкремента
- [x] Сохранить текущую UX-модель `start/end` assignment.
- [x] Добавить внутри диапазона профиль загрузки сотрудника (не только константа), совместимый с day/month режимами.

2. Модель данных (этап 1 — без сложной математики)
- [x] Ввести внутренние `key points` для assignment: `(date, value%)`.
- [x] На MVP использовать piecewise-linear интерполяцию между точками (без bezier/tangents).
- [x] Ограничения: `value` в диапазоне `0..100`, даты точек внутри assignment-диапазона.
- [x] Начальная и конечная точки кривой могут иметь любое значение в диапазоне `0..100` (включая `0` и `100`).
- [x] Добавить флаг режима профиля: `flat | curve` (для обратной совместимости).

3. Backend/API
- [x] Расширить DTO assignment полем профиля загрузки (`loadProfile`).
- [x] Добавить серверную валидацию:
   - [x] минимум 2 точки для `curve`,
   - [x] строго возрастающие даты точек,
   - [x] точки не выходят за `assignment.start/end`.
- [x] В `ProjectDetail` и timeline-response вернуть нормализованный профиль для UI.
- [x] Зафиксировать error-коды для невалидного профиля (единый стиль с `ERR_*`).

4. Frontend UX (MVP)
- [ ] В `AssignmentModal` добавить переключатель: `Константа` / `Кривая`.
- [ ] Для `Кривая` добавить простой редактор точек (дата + %), без ручек/tangent.
- [x] При resize assignment пересчитывать даты внутренних точек пропорционально новой длине диапазона (с сохранением относительных позиций точек).
- [x] В timeline использовать дневное/месячное семплирование профиля и существующий рендер.
- [x] При отсутствии профиля поведение полностью как сейчас (flat).

  Текущее фактическое состояние UI:
  - редактор кривой реализован inline прямо в полоске timeline assignment (точки + drag);
  - реализованы улучшения UX рендера (area-график по цвету роли, value-indicator при drag, отдельная чувствительность drag по осям);
  - modal-редактор кривой пока не внедрялся. ( и не нужно )

5. Тесты и smoke
- [ ] API: create/update assignment с `flat` и `curve` профилями.
- [ ] API: негативные кейсы (`value > 100`, неупорядоченные даты, выход за границы).
- [ ] UI smoke: переключение режима, сохранение, перезагрузка страницы, консистентный рендер в day/month.

6. Этап 2 (после MVP)
- [ ] Добавить опциональную нормализацию месячных значений для отчетов/стоимости.

## 2.2 UX входа/аккаунта и открытые вопросы (2026-02-17)

### Что принято в ближайшем инкременте (UX-only)
- [x] Перевести карточку профиля пользователя в pop-up по паттерну login/register.
- [x] Усилить обратную связь формы входа/регистрации:
   - [x] явные toast-ошибки при неуспешной авторизации,
   - [x] одинаковое поведение для backend ошибок и локальных валидаций.
- [x] Перенести глобальный toast-stack из левого нижнего угла в нижний центр.
- [x] В хедере показывать, кто авторизован (ФИО вместо абстрактного «Аккаунт»).
- [x] Переместить контрол пользователя левее переключателя языка.

### Открытые вопросы по организациям/workspace
- [ ] Как выбирать организацию/workspace в UI.
- [ ] В этом инкременте зафиксирован режим **без переключения workspace** (UX-only).
- [ ] Переключение workspace вынести в отдельный этап после полноценного backend-контракта:
   - пользователь может видеть все расшаренные ему воркспейсы и переключаться между ними
   - [ ] список membership,
   - [ ] смена active workspace,
   - [ ] полное tenant-scoping покрытие модулей timeline/assignments/vacations/cost-rates.

- [x] Проверить и исправить логику скамейки, чтобы в ней всегда отображались все сотрудники (включая кейсы с частичной/нулевой загрузкой, фильтрами и сменой года).
- [x] Перенести «таймлайн года» в ту же колонку, где отображаются проекты, чтобы при увеличении высоты скамейки все таймлайны оставались одной ширины.
- [x] Добавить фильтр по сотруднику на скамейке:
   - [x] при выборе сотрудника остаются только проекты/таймлайны, где он участвует;
   - [x] в этих таймлайнах визуально выделяется только выбранный сотрудник.
- [ ] Проверить общий таймлайн в режиме шага «день»: в выходные дни не должна отображаться нагрузка;
   - [x] найти источник ошибки (визуализация столбцов или расчет метрик);
   - [x] исправить расчет/рендер.
   - [ ] подтвердить корректность на ручном smoke-сценарии.
- [x] Добавить для проектов шаблон требований к составу команды (например: обязательный PM, Lead и другие роли по конфигурации):
   - [x] определить формат шаблона и где он хранится (настройки/справочник/уровень проекта);
   - [x] реализовать проверку соответствия фактического состава сотрудников шаблону;
   - [x] добавить API и UI для выбора/привязки шаблона к проекту.
- [x] Добавить в таймлайн отдельный блок «Ошибки» с красными иконками и tooltip-пояснениями:
   - [x] показывать нехватку сотрудников по проектному шаблону (кто именно отсутствует);
   - [x] показывать наличие отпусков у сотрудников проекта в плановом периоде;
   - [x] показывать выход факта за пределы плана (по часам/нагрузке);
   - [x] унифицировать приоритет и сортировку ошибок, чтобы критичные всегда были выше.

## 2.3 План-ориентированная модель доступа (kickoff: 2026-02-17)

### Подтвержденная идеология
- [x] Уровень агрегации экрана «Мои проекты»: это **планы** (бывшие workspace / project space), а не отдельные проекты timeline.
- [x] Терминология: карточки на стартовом экране трактуются как карточки планов.
- [x] Пользователь может иметь несколько планов и переключаться между ними.
- [x] Стартовый экран после входа: «Мои планы» + «Планы, куда меня добавили» + кнопка создания нового плана.
- [x] В рабочем экране над таймлайном отображается название текущего плана и кнопка возврата на стартовый экран.
- [x] Люди, их грейды и ключевые настройки шарятся между планами одного владельца.
- [x] Расчетные метрики (нагрузка/часы/стоимость) считаются в границах активного плана и не смешиваются между планами.
- [ ] Права внутри плана:
   - [x] `owner`: полный доступ ко всем вкладкам и настройкам плана,
   - [x] `editor`: полный доступ в таймлайне, просмотр участников без управления правами,
   - [x] `viewer`: только просмотр таймлайна.
- [~] Вводим уровень агрегации выше планов: «компании», внутри которых ведутся независимые наборы планов.

### Текущий статус (первый инкремент)
- [x] Backend: добавлены endpoints для списка доступных планов пользователя, создания плана и переключения active плана (через `auth` API).
- [x] Frontend: реализован базовый стартовый экран выбора плана и переключение контекста через `auth/projects` endpoints.
- [x] Frontend: список планов на стартовом экране переведен на карточки с переходом по клику.
- [x] Frontend UX: карточки планов сделаны квадратными; создание плана перенесено в пустую `+` карточку с auto-name `unnamed + date-time`.
- [x] Frontend: единый project pop-up (участники + редактирование названия owner-only) вызывается и со стартового экрана, и из шапки рабочего экрана.
- [x] Frontend/Backend: owner-only управление участниками плана в pop-up (смена роли viewer/editor, удаление участника).
- [x] Frontend/Backend: owner-only удаление плана из pop-up с подтверждением через ввод слова `delete`.
- [x] QA/UX: добавлен confirm на удаление участника и API smoke-сценарий update/remove роли участника.
- [x] UX: добавлен быстрый поиск участников в project pop-up (по ФИО/email).
- [x] UX: добавлены унифицированные tooltip для icon-only кнопок с micro-delay показа.
- [x] Backend: добавить приглашение по email существующего пользователя с назначением `viewer/editor`.
- [x] Backend: довести полное scoping-покрытие модулей `timeline/assignments/vacations/cost-rates`.
   - [x] assignments: scoping на уровень активного плана.
   - [x] timeline: scoping на уровень активного плана.
   - [x] vacations: scoping на уровень активного плана.
   - [x] cost-rates: scoping на уровень активного плана.
- [x] Backend: сотрудники доступны между планами одного владельца (owner-scoped shared team без дублирования сотрудников).
- [x] Frontend: добавить owner-only pop-up настроек проекта (участники, роли доступа, приглашения).
- [x] Frontend: добавлен role-gating вкладок/модалок по модели owner/editor/viewer.
- [x] Backend: editor ограничен от мутаций вне timeline (employees/vacations/skills assignment).
- [x] Backend: добавлена сущность `Company` и связь `Workspace -> Company`.
- [x] Backend: каталоги (roles/departments/grades/team-templates) переведены на company-scoping с legacy fallback.

### Следующие UX шаги по карточкам планов
- [ ] Переименовать пользовательские тексты стартового экрана с «проектов» на «планы».
- [ ] Добавить на каждую карточку плана кнопку «Копия» с tooltip «Скопировать план».
- [ ] Поведение копии: создается новый план с суффиксом `_v(x)` в имени.
- [ ] Добавить в карточки планов сравнительные показатели (KPI) для быстрого сравнения планов на стартовом экране.

## 2.4 Company context UX (kickoff: 2026-02-18)

### Цель инкремента
- [x] Пользователь управляет компаниями на стартовом экране: выбор, переименование, создание.
- [x] Company становится первичным контекстом для справочников и планов.

### Scope текущей ветки `feat/company-selector-mvp`
- [x] Frontend: справа от `Projo Planner` добавить выпадающий список компаний пользователя.
- [x] Frontend: справа от выпадашки добавить кнопку «карандаш» с pop-up редактирования названия компании.
- [x] Frontend: справа от «карандаша» добавить кнопку «плюс» с pop-up создания компании.
- [x] Frontend: гарантировать, что не может быть состояния без выбранной компании.
- [x] Backend: гарантировать, что у пользователя всегда существует минимум одна компания.
- [x] UX: правые кнопки в хедере (команда/настройки/аккаунт) не скрываются при пустом списке планов, т.к. относятся к company-контексту.

### Технические шаги
- [x] API: добавить endpoints компаний (list/create/update/select-active).
- [x] Auth contract: вернуть активную компанию и список компаний в стартовой загрузке.
- [x] Web state: добавить `activeCompanyId` и `companies` в app-state + handlers.
- [x] Account modal: показывать имя активной компании вместо технического `workspaceId`.
- [x] Smoke: добавить e2e сценарий `company create -> rename -> select`.

## 3. Принципы поставки
- Двигаемся короткими вертикальными инкрементами (API + UI + docs + smoke).
- Любое изменение схемы БД сопровождается Prisma migration.
- Документация (`README` + `docs/*`) обновляется в том же инкременте.

## 4. Связанные документы
- API-контракты: `docs/api-reference.md`.
- Процедурный чеклист инкремента: `docs/workflow-checklist.md`.