# План импорта XLSX (новая компания) → Projo (кривая загрузки)

Дата: 2026-02-24

## 1) Цель
Импортировать XLSX с большим количеством проектов и помесячными значениями загрузки сотрудников в новую компанию Projo.

Ключевое ограничение: в Projo нет «загрузки по месяцам» как отдельной модели — есть `loadProfile` (кривая) на assignment.

## 2) Что считаем входом
Ожидаемая структура XLSX (минимально):
- Колонки справа — **месяцы** (в шапке дата = 1-е число месяца).
- Значения в ячейках — **проценты загрузки** (0..100).
- Строки содержат сотрудника (ФИО) и его значения по месяцам внутри проекта.
- Проекты сгруппированы блоками (каждый блок = отдельный проект).

Идентификация сотрудника при импорте: **ФИО уникально в рамках новой компании** (после нормализации пробелов).

Пустые значения внутри диапазона: **заполняем 0%**.

## 3) Целевое представление в Projo
Создаём:
- Company + Workspace (новая компания)
- Projects
- Employees
- ProjectMember (если требуется текущими инвариантами)
- ProjectAssignment

Важно про assignments:
- В БД действует уникальность `(projectId, employeeId)` → у сотрудника может быть только 1 assignment на проект.
- Поэтому «дыры» по периодам внутри одного проекта нужно приводить к непрерывной кривой (выбрали правило: пусто = 0%).

## 4) Конвертация «месяцы → кривая»
### 4.1 Даты assignment
Для каждой пары (project × employee):
1) Собираем месячные значения по колонкам в хронологическом порядке.
2) Определяем диапазон импорта:
   - `firstMonth` = первый месяц, где значение задано
   - `lastMonth` = последний месяц, где значение задано
3) `assignmentStartDate` = UTC 00:00 первого дня `firstMonth`.
4) `assignmentEndDate` = UTC 00:00 последнего дня `lastMonth`.

### 4.2 Точки loadProfile (ступенчато по месяцам)
Используем `mode: "curve"`.

Чтобы пройти валидацию `normalizeLoadProfile`:
- первая точка должна лежать в UTC-дне `assignmentStartDate`
- последняя точка должна лежать в UTC-дне `assignmentEndDate`
- timestamps строго возрастают
- каждая точка внутри `[assignmentStartDate, assignmentEndDate]`

Рецепт:
- Для каждого месяца в диапазоне добавляем 2 точки:
  - `monthStart` (UTC 00:00 1-го числа месяца) со значением месяца
  - `monthEndDay` (UTC 00:00 последнего дня месяца) со значением месяца
- Внутренние пустые месяцы заменяем на 0%.

Это создаёт «ступеньки» по месяцам без необходимости отдельной помесячной модели.

## 5) API: 2-фазный импорт (preview → apply)
### 5.1 Preview
`POST /imports/xlsx/company/preview` (multipart XLSX)
- Парсит XLSX
- Возвращает:
  - counts (projects/employees/assignments)
  - список ошибок/предупреждений с координатами (лист/строка/колонка)
  - summary по распознанным месяцам (диапазон дат)

### 5.2 Apply
`POST /imports/xlsx/company/apply` (multipart XLSX)
- Повторно парсит файл (или использует token/hash из preview — опционально)
- В транзакции:
  - создаёт company+workspace
  - создаёт справочники (roles/departments) при наличии данных
  - создаёт employees
  - создаёт projects
  - создаёт assignments с `loadProfile`
- Возвращает ids созданных сущностей + статистику

## 6) Парсер XLSX
Библиотека: `exceljs`.

Минимальные требования к парсеру:
- Умеет читать merged-cells для названия проекта (если в файле так оформлено)
- Находит «линию месяцев» (шапку) и определяет индекс первой/последней месячной колонки
- Нормализует даты к UTC (startOfUtcDay)
- Строго валидирует проценты (0..100)

## 7) Идемпотентность и коллизии
Так как импорт создаёт **новую компанию**, внутри одного импорта:
- Сотрудники уникальны по нормализованному ФИО.
- Проекты уникальны по `code` в рамках workspace → код генерируем детерминированно (slug + суффикс при коллизии).

## 8) Smoke/проверки
- Preview на заведомо плохом файле должен возвращать понятные ошибки.
- Apply на корректном файле:
  - company/workspace создан
  - timeline не падает
  - выборочно 1–2 assignment: валидная кривая (якоря на start/end, monotonic даты, значения 0..100)

## 9) Открытые вопросы (если появятся в реальном файле)
- Где именно в таблице лежит роль/отдел/грейд (если нужно импортировать справочники)?
- Есть ли строка итогов/подвал, который нужно игнорировать?
- Есть ли строки сотрудников, которые повторяются в разных проектах с разными ролями?
